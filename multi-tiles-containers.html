
<!DOCTYPE html>
<html lang="zh_cn">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="index, follow" />

  <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Source+Sans+Pro:300,400,400i,700" rel="stylesheet">

    <link rel="stylesheet/less" type="text/css" href="./theme/stylesheet/style.less">
    <script src="//cdnjs.cloudflare.com/ajax/libs/less.js/2.5.1/less.min.js" type="text/javascript"></script>

  <link rel="stylesheet" type="text/css" href="./theme/pygments/friendly.min.css">
  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/font-awesome.min.css">

    <link href="./static/custom.css" rel="stylesheet">

    <link href="https://xingzuoshe.cn/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Martin's Blog Atom">


    <link rel="shortcut icon" href="/images/default_profile_200x200.png" type="image/x-icon">
    <link rel="icon" href="/images/default_profile_200x200.png" type="image/x-icon">


    <!-- Chrome, Firefox OS and Opera -->
    <meta name="theme-color" content="#333333">
    <!-- Windows Phone -->
    <meta name="msapplication-navbutton-color" content="#333333">
    <!-- iOS Safari -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Microsoft EDGE -->
    <meta name="msapplication-TileColor" content="#333333">

<meta name="author" content="Martin" />
<meta name="description" content="使用 multiple container 实现 同一套代码，不同的站点，不同的样式" />
<meta name="keywords" content="java">

<meta property="og:site_name" content="Martin's Blog"/>
<meta property="og:title" content="multiple tiles containers"/>
<meta property="og:description" content="使用 multiple container 实现 同一套代码，不同的站点，不同的样式"/>
<meta property="og:locale" content="zh_CN"/>
<meta property="og:url" content="./multi-tiles-containers.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2020-07-09 17:00:00+08:00"/>
<meta property="article:modified_time" content="2020-07-09 17:00:00+08:00"/>
<meta property="article:author" content="./author/martin.html">
<meta property="article:section" content="Java"/>
<meta property="article:tag" content="java"/>
<meta property="og:image" content="/images/default_profile_200x200.png">

  <title>Martin's Blog &ndash; multiple tiles containers</title>

</head>
<body>
  <aside>
    <div>
      <a href=".">
        <img src="/images/default_profile_200x200.png" alt="Martin's Blog" title="Martin's Blog">
      </a>
      <h1><a href=".">Martin's Blog</a></h1>

<p>Martin's Blog</p>
      <nav>
        <ul class="list">
          <li><a href="./pages/about.html#about">About</a></li>

          <li><a href="https://astrobook.cn/" target="_blank">astrobook</a></li>
          <li><a href="https://astrohub.cn" target="_blank">astrohub</a></li>
        </ul>
      </nav>

      <ul class="social">
        <li><a class="sc-github" href="https://github.com/openmartin" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-rss" href="/blog/feeds/all.atom.xml" target="_blank"><i class="fa fa-rss"></i></a></li>
      </ul>
    </div>


  </aside>
  <main>

    <nav>
      <a href=".">Home</a>

      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>

      <a href="https://xingzuoshe.cn/feeds/all.atom.xml">Atom</a>

    </nav>

<article class="single">
  <header>
      
    <h1 id="multi-tiles-containers">multiple tiles containers</h1>
    <p>
      Posted on 2020-07-09 17:00 in <a href="./category/java.html">Java</a>

    </p>
  </header>


  <div>
    <p>其实使用 spring mvc theme 也可以实现同样的需求，不过还是用 tiles multiple container 更加灵活一些。</p>
<h2>multiple-containers</h2>
<p>https://tiles.apache.org/framework/tutorial/advanced/multiple-containers.html</p>
<p>一套代码，多个site显示不一样</p>
<ol>
<li>新增一个 Servlet Filter：通过 request 的域名来判断是那个站点，request.setAttribute</li>
<li>多个 tiles container</li>
<li>新建 tilesView，通过站点来判断，用不同的 tiles container 来输出</li>
<li>加载 definition 的时候修改来实现不同的站点不同的 definition</li>
</ol>
<h3>SiteFilter</h3>
<div class="highlight"><pre><span></span><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SiteFilter</span> <span class="kd">implements</span> <span class="n">Filter</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">SITE_FILTER_ATTRIBUTE</span> <span class="o">=</span> <span class="s">&quot;SITE_FILTER_ATTRIBUTE&quot;</span><span class="p">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">EXAMPLE1_SITE</span> <span class="o">=</span> <span class="s">&quot;example1&quot;</span><span class="p">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">EXAMPLE2_SITE</span> <span class="o">=</span> <span class="s">&quot;example2&quot;</span><span class="p">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">EXAMPLE1_SITE_DOMAIN</span> <span class="o">=</span> <span class="s">&quot;example1.com&quot;</span><span class="p">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">EXAMPLE2_SITE_DOMAIN</span> <span class="o">=</span> <span class="s">&quot;example2.com&quot;</span><span class="p">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="p">(</span><span class="n">FilterConfig</span> <span class="n">filterConfig</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">ServletException</span> <span class="p">{</span>

    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doFilter</span><span class="p">(</span><span class="n">ServletRequest</span> <span class="n">request</span><span class="p">,</span> <span class="n">ServletResponse</span> <span class="n">response</span><span class="p">,</span> <span class="n">FilterChain</span> <span class="n">chain</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="p">,</span> <span class="n">ServletException</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="na">getAttribute</span><span class="p">(</span><span class="s">&quot;SITE_FILTER_ATTRIBUTE&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">chain</span><span class="p">.</span><span class="na">doFilter</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">String</span> <span class="n">site</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="na">getServerName</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">EXAMPLE1_SITE_DOMAIN</span><span class="p">)){</span>
                <span class="n">site</span> <span class="o">=</span> <span class="n">EXAMPLE1_SITE</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="na">getServerName</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">EXAMPLE2_SITE_DOMAIN</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">site</span> <span class="o">=</span> <span class="n">EXAMPLE2_SITE</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">site</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">site</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="na">getParameter</span><span class="p">(</span><span class="s">&quot;site&quot;</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">EXAMPLE1_SITE</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">site</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">request</span><span class="p">.</span><span class="na">setAttribute</span><span class="p">(</span><span class="n">SITE_FILTER_ATTRIBUTE</span><span class="p">,</span> <span class="n">EXAMPLE1_SITE</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">EXAMPLE2_SITE</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">site</span><span class="p">)){</span>
                <span class="n">request</span><span class="p">.</span><span class="na">setAttribute</span><span class="p">(</span><span class="n">SITE_FILTER_ATTRIBUTE</span><span class="p">,</span> <span class="n">EXAMPLE2_SITE</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// 默认是 EXAMPLE1_SITE</span>
                <span class="n">request</span><span class="p">.</span><span class="na">setAttribute</span><span class="p">(</span><span class="n">SITE_FILTER_ATTRIBUTE</span><span class="p">,</span> <span class="n">EXAMPLE1_SITE</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="n">chain</span><span class="p">.</span><span class="na">doFilter</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">destroy</span><span class="p">()</span> <span class="p">{</span>

    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<h3>SiteTilesView</h3>
<p>把默认的 <code>org.springframework.web.servlet.view.tiles3.TilesView</code> 替换为自己写的 <code>SiteTilesView</code></p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;viewResolver&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.web.servlet.view.UrlBasedViewResolver&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;viewClass&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;value&gt;</span>
            com.example.web.tiles.SiteTilesView
        <span class="nt">&lt;/value&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</code></pre></div>


<p>在 TilesView 上修改，根据 filter 中设置的 SITE_FILTER_ATTRIBUTE，使用不同的 Tiles Container 来 render。</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SiteTilesView</span> <span class="kd">extends</span> <span class="n">AbstractUrlBasedView</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Renderer</span><span class="o">&gt;</span> <span class="n">siteRendererMap</span><span class="p">;</span>

    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">exposeJstlAttributes</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">alwaysInclude</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">ApplicationContext</span> <span class="n">applicationContext</span><span class="p">;</span>


    <span class="cm">/**</span>
<span class="cm">     * Whether to expose JSTL attributes. By default set to {@code true}.</span>
<span class="cm">     *</span>
<span class="cm">     * @see JstlUtils#exposeLocalizationContext(RequestContext)</span>
<span class="cm">     */</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">setExposeJstlAttributes</span><span class="p">(</span><span class="kt">boolean</span> <span class="n">exposeJstlAttributes</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">exposeJstlAttributes</span> <span class="o">=</span> <span class="n">exposeJstlAttributes</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Specify whether to always include the view rather than forward to it.</span>
<span class="cm">     * &lt;p&gt;Default is &quot;false&quot;. Switch this flag on to enforce the use of a</span>
<span class="cm">     * Servlet include, even if a forward would be possible.</span>
<span class="cm">     *</span>
<span class="cm">     * @see TilesViewResolver#setAlwaysInclude</span>
<span class="cm">     * @since 4.1.2</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAlwaysInclude</span><span class="p">(</span><span class="kt">boolean</span> <span class="n">alwaysInclude</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">alwaysInclude</span> <span class="o">=</span> <span class="n">alwaysInclude</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">afterPropertiesSet</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
        <span class="kd">super</span><span class="p">.</span><span class="na">afterPropertiesSet</span><span class="p">();</span>

        <span class="n">ServletContext</span> <span class="n">servletContext</span> <span class="o">=</span> <span class="n">getServletContext</span><span class="p">();</span>
        <span class="n">Assert</span><span class="p">.</span><span class="na">state</span><span class="p">(</span><span class="n">servletContext</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">,</span> <span class="s">&quot;No ServletContext&quot;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="na">applicationContext</span> <span class="o">=</span> <span class="n">ServletUtil</span><span class="p">.</span><span class="na">getApplicationContext</span><span class="p">(</span><span class="n">servletContext</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">siteRendererMap</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">siteRendererMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
            <span class="n">TilesContainer</span> <span class="n">defaultContainer</span> <span class="o">=</span> <span class="n">TilesAccess</span><span class="p">.</span><span class="na">getContainer</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">applicationContext</span><span class="p">);</span>
            <span class="n">Renderer</span> <span class="n">defaultRenderer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefinitionRenderer</span><span class="p">(</span><span class="n">defaultContainer</span><span class="p">);</span>

            <span class="n">siteRendererMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;example1&quot;</span><span class="p">,</span> <span class="n">defaultRenderer</span><span class="p">);</span>

            <span class="n">TilesContainer</span> <span class="n">fiContainer</span> <span class="o">=</span> <span class="n">TilesAccess</span><span class="p">.</span><span class="na">getContainer</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">applicationContext</span><span class="p">,</span> <span class="s">&quot;example2&quot;</span><span class="p">);</span>
            <span class="n">Renderer</span> <span class="n">fiRenderer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefinitionRenderer</span><span class="p">(</span><span class="n">fiContainer</span><span class="p">);</span>

            <span class="n">siteRendererMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;example2&quot;</span><span class="p">,</span> <span class="n">fiRenderer</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">checkResource</span><span class="p">(</span><span class="kd">final</span> <span class="n">Locale</span> <span class="n">locale</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
        <span class="n">Assert</span><span class="p">.</span><span class="na">state</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">siteRendererMap</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">,</span> <span class="s">&quot;No Renderer set&quot;</span><span class="p">);</span>

        <span class="n">HttpServletRequest</span> <span class="n">servletRequest</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="n">RequestAttributes</span> <span class="n">requestAttributes</span> <span class="o">=</span> <span class="n">RequestContextHolder</span><span class="p">.</span><span class="na">getRequestAttributes</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">requestAttributes</span> <span class="k">instanceof</span> <span class="n">ServletRequestAttributes</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">servletRequest</span> <span class="o">=</span> <span class="p">((</span><span class="n">ServletRequestAttributes</span><span class="p">)</span> <span class="n">requestAttributes</span><span class="p">).</span><span class="na">getRequest</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="n">String</span> <span class="n">site</span> <span class="o">=</span> <span class="p">(</span><span class="n">String</span><span class="p">)</span> <span class="n">requestAttributes</span><span class="p">.</span><span class="na">getAttribute</span><span class="p">(</span><span class="n">SiteFilter</span><span class="p">.</span><span class="na">SITE_FILTER_ATTRIBUTE</span><span class="p">,</span> <span class="n">RequestAttributes</span><span class="p">.</span><span class="na">SCOPE_REQUEST</span><span class="p">);</span>

        <span class="n">Request</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServletRequest</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">applicationContext</span><span class="p">,</span> <span class="n">servletRequest</span><span class="p">,</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">Locale</span> <span class="nf">getRequestLocale</span><span class="p">()</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">locale</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">};</span>

        <span class="n">Renderer</span> <span class="n">renderer</span> <span class="o">=</span> <span class="n">siteRendererMap</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">site</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">renderer</span><span class="p">.</span><span class="na">isRenderable</span><span class="p">(</span><span class="n">getUrl</span><span class="p">(),</span> <span class="n">request</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">renderMergedOutputModel</span><span class="p">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">model</span><span class="p">,</span> <span class="n">HttpServletRequest</span> <span class="n">request</span><span class="p">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
        <span class="n">Assert</span><span class="p">.</span><span class="na">state</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">siteRendererMap</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">,</span> <span class="s">&quot;No Renderer set&quot;</span><span class="p">);</span>

        <span class="n">exposeModelAsRequestAttributes</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">exposeJstlAttributes</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">JstlUtils</span><span class="p">.</span><span class="na">exposeLocalizationContext</span><span class="p">(</span><span class="k">new</span> <span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">getServletContext</span><span class="p">()));</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">alwaysInclude</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">request</span><span class="p">.</span><span class="na">setAttribute</span><span class="p">(</span><span class="n">AbstractRequest</span><span class="p">.</span><span class="na">FORCE_INCLUDE_ATTRIBUTE_NAME</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">String</span> <span class="n">site</span> <span class="o">=</span> <span class="p">(</span><span class="n">String</span><span class="p">)</span> <span class="n">request</span><span class="p">.</span><span class="na">getAttribute</span><span class="p">(</span><span class="n">SiteFilter</span><span class="p">.</span><span class="na">SITE_FILTER_ATTRIBUTE</span><span class="p">);</span>

        <span class="n">Request</span> <span class="n">tilesRequest</span> <span class="o">=</span> <span class="n">createTilesRequest</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">);</span>

        <span class="n">Renderer</span> <span class="n">renderer</span> <span class="o">=</span> <span class="n">siteRendererMap</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">site</span><span class="p">);</span>
        <span class="n">renderer</span><span class="p">.</span><span class="na">render</span><span class="p">(</span><span class="n">getUrl</span><span class="p">(),</span> <span class="n">tilesRequest</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Create a Tiles {@link Request}.</span>
<span class="cm">     * &lt;p&gt;This implementation creates a {@link ServletRequest}.</span>
<span class="cm">     *</span>
<span class="cm">     * @param request  the current request</span>
<span class="cm">     * @param response the current response</span>
<span class="cm">     * @return the Tiles request</span>
<span class="cm">     */</span>
    <span class="kd">protected</span> <span class="n">Request</span> <span class="nf">createTilesRequest</span><span class="p">(</span><span class="kd">final</span> <span class="n">HttpServletRequest</span> <span class="n">request</span><span class="p">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">ServletRequest</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">applicationContext</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span> <span class="p">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">Locale</span> <span class="nf">getRequestLocale</span><span class="p">()</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">RequestContextUtils</span><span class="p">.</span><span class="na">getLocale</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">};</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<h3>SiteSpringTilesConfigurer</h3>
<p>系统默认的 <code>org.springframework.web.servlet.view.tiles3.TilesConfigurer</code> 只能初始化一个 default 的 container，新建一个 <code>SiteSpringTilesConfigurer</code></p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SiteSpringTilesConfigurer</span> <span class="kd">implements</span> <span class="n">ServletContextAware</span><span class="p">,</span> <span class="n">InitializingBean</span><span class="p">,</span> <span class="n">DisposableBean</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">tilesElPresent</span> <span class="o">=</span>
            <span class="n">ClassUtils</span><span class="p">.</span><span class="na">isPresent</span><span class="p">(</span><span class="s">&quot;org.apache.tiles.el.ELAttributeEvaluator&quot;</span><span class="p">,</span> <span class="n">SiteSpringTilesConfigurer</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getClassLoader</span><span class="p">());</span>


    <span class="kd">protected</span> <span class="kd">final</span> <span class="n">Log</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">LogFactory</span><span class="p">.</span><span class="na">getLog</span><span class="p">(</span><span class="n">getClass</span><span class="p">());</span>

    <span class="kd">private</span> <span class="n">TilesInitializer</span> <span class="n">tilesInitializer</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">String</span><span class="o">[]</span> <span class="n">definitions</span><span class="p">;</span>

    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">checkRefresh</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">validateDefinitions</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">DefinitionsFactory</span><span class="o">&gt;</span> <span class="n">definitionsFactoryClass</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">PreparerFactory</span><span class="o">&gt;</span> <span class="n">preparerFactoryClass</span><span class="p">;</span>

    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">useMutableTilesContainer</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">ServletContext</span> <span class="n">servletContext</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">containerKey</span><span class="p">;</span>


    <span class="cm">/**</span>
<span class="cm">     * Configure Tiles using a custom TilesInitializer, typically specified as an inner bean.</span>
<span class="cm">     * &lt;p&gt;Default is a variant of {@link org.apache.tiles.startup.DefaultTilesInitializer},</span>
<span class="cm">     * respecting the &quot;definitions&quot;, &quot;preparerFactoryClass&quot; etc properties on this configurer.</span>
<span class="cm">     * &lt;p&gt;&lt;b&gt;NOTE: Specifying a custom TilesInitializer effectively disables all other bean</span>
<span class="cm">     * properties on this configurer.&lt;/b&gt; The entire initialization procedure is then left</span>
<span class="cm">     * to the TilesInitializer as specified.</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTilesInitializer</span><span class="p">(</span><span class="n">TilesInitializer</span> <span class="n">tilesInitializer</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">tilesInitializer</span> <span class="o">=</span> <span class="n">tilesInitializer</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Set the Tiles definitions, i.e. the list of files containing the definitions.</span>
<span class="cm">     * Default is &quot;/WEB-INF/tiles.xml&quot;.</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDefinitions</span><span class="p">(</span><span class="n">String</span><span class="p">...</span> <span class="n">definitions</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">definitions</span> <span class="o">=</span> <span class="n">definitions</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Set whether to check Tiles definition files for a refresh at runtime.</span>
<span class="cm">     * Default is &quot;false&quot;.</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCheckRefresh</span><span class="p">(</span><span class="kt">boolean</span> <span class="n">checkRefresh</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">checkRefresh</span> <span class="o">=</span> <span class="n">checkRefresh</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Set whether to validate the Tiles XML definitions. Default is &quot;true&quot;.</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setValidateDefinitions</span><span class="p">(</span><span class="kt">boolean</span> <span class="n">validateDefinitions</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">validateDefinitions</span> <span class="o">=</span> <span class="n">validateDefinitions</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Set the {@link org.apache.tiles.definition.DefinitionsFactory} implementation to use.</span>
<span class="cm">     * Default is {@link org.apache.tiles.definition.UnresolvingLocaleDefinitionsFactory},</span>
<span class="cm">     * operating on definition resource URLs.</span>
<span class="cm">     * &lt;p&gt;Specify a custom DefinitionsFactory, e.g. a UrlDefinitionsFactory subclass,</span>
<span class="cm">     * to customize the creation of Tiles Definition objects. Note that such a</span>
<span class="cm">     * DefinitionsFactory has to be able to handle {@link java.net.URL} source objects,</span>
<span class="cm">     * unless you configure a different TilesContainerFactory.</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDefinitionsFactoryClass</span><span class="p">(</span><span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">DefinitionsFactory</span><span class="o">&gt;</span> <span class="n">definitionsFactoryClass</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">definitionsFactoryClass</span> <span class="o">=</span> <span class="n">definitionsFactoryClass</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Set the {@link org.apache.tiles.preparer.factory.PreparerFactory} implementation to use.</span>
<span class="cm">     * Default is {@link org.apache.tiles.preparer.factory.BasicPreparerFactory}, creating</span>
<span class="cm">     * shared instances for specified preparer classes.</span>
<span class="cm">     * &lt;p&gt;Specify {@link SimpleSpringPreparerFactory} to autowire</span>
<span class="cm">     * {@link org.apache.tiles.preparer.ViewPreparer} instances based on specified</span>
<span class="cm">     * preparer classes, applying Spring&#39;s container callbacks as well as applying</span>
<span class="cm">     * configured Spring BeanPostProcessors. If Spring&#39;s context-wide annotation-config</span>
<span class="cm">     * has been activated, annotations in ViewPreparer classes will be automatically</span>
<span class="cm">     * detected and applied.</span>
<span class="cm">     * &lt;p&gt;Specify {@link SpringBeanPreparerFactory} to operate on specified preparer</span>
<span class="cm">     * &lt;i&gt;names&lt;/i&gt; instead of classes, obtaining the corresponding Spring bean from</span>
<span class="cm">     * the DispatcherServlet&#39;s application context. The full bean creation process</span>
<span class="cm">     * will be in the control of the Spring application context in this case,</span>
<span class="cm">     * allowing for the use of scoped beans etc. Note that you need to define one</span>
<span class="cm">     * Spring bean definition per preparer name (as used in your Tiles definitions).</span>
<span class="cm">     *</span>
<span class="cm">     * @see SimpleSpringPreparerFactory</span>
<span class="cm">     * @see SpringBeanPreparerFactory</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setPreparerFactoryClass</span><span class="p">(</span><span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">PreparerFactory</span><span class="o">&gt;</span> <span class="n">preparerFactoryClass</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">preparerFactoryClass</span> <span class="o">=</span> <span class="n">preparerFactoryClass</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Set whether to use a MutableTilesContainer (typically the CachingTilesContainer</span>
<span class="cm">     * implementation) for this application. Default is &quot;false&quot;.</span>
<span class="cm">     *</span>
<span class="cm">     * @see org.apache.tiles.mgmt.MutableTilesContainer</span>
<span class="cm">     * @see org.apache.tiles.impl.mgmt.CachingTilesContainer</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUseMutableTilesContainer</span><span class="p">(</span><span class="kt">boolean</span> <span class="n">useMutableTilesContainer</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">useMutableTilesContainer</span> <span class="o">=</span> <span class="n">useMutableTilesContainer</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setServletContext</span><span class="p">(</span><span class="n">ServletContext</span> <span class="n">servletContext</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">servletContext</span> <span class="o">=</span> <span class="n">servletContext</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setContainerKey</span><span class="p">(</span><span class="n">String</span> <span class="n">containerKey</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">containerKey</span> <span class="o">=</span> <span class="n">containerKey</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Creates and exposes a TilesContainer for this web application,</span>
<span class="cm">     * delegating to the TilesInitializer.</span>
<span class="cm">     *</span>
<span class="cm">     * @throws TilesException in case of setup failure</span>
<span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">afterPropertiesSet</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">TilesException</span> <span class="p">{</span>
        <span class="n">ApplicationContext</span> <span class="n">preliminaryContext</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SpringWildcardServletTilesApplicationContext</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">servletContext</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">tilesInitializer</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="na">tilesInitializer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SiteSpringTilesInitializer</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="na">tilesInitializer</span><span class="p">.</span><span class="na">initialize</span><span class="p">(</span><span class="n">preliminaryContext</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Removes the TilesContainer from this web application.</span>
<span class="cm">     *</span>
<span class="cm">     * @throws TilesException in case of cleanup failure</span>
<span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">destroy</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">TilesException</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">tilesInitializer</span><span class="p">.</span><span class="na">destroy</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">CompositeELResolverImpl</span> <span class="kd">extends</span> <span class="n">CompositeELResolver</span> <span class="p">{</span>

        <span class="kd">public</span> <span class="nf">CompositeELResolverImpl</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">add</span><span class="p">(</span><span class="k">new</span> <span class="n">ScopeELResolver</span><span class="p">());</span>
            <span class="n">add</span><span class="p">(</span><span class="k">new</span> <span class="n">TilesContextELResolver</span><span class="p">(</span><span class="k">new</span> <span class="n">TilesContextBeanELResolver</span><span class="p">()));</span>
            <span class="n">add</span><span class="p">(</span><span class="k">new</span> <span class="n">TilesContextBeanELResolver</span><span class="p">());</span>
            <span class="n">add</span><span class="p">(</span><span class="k">new</span> <span class="n">ArrayELResolver</span><span class="p">(</span><span class="kc">false</span><span class="p">));</span>
            <span class="n">add</span><span class="p">(</span><span class="k">new</span> <span class="n">ListELResolver</span><span class="p">(</span><span class="kc">false</span><span class="p">));</span>
            <span class="n">add</span><span class="p">(</span><span class="k">new</span> <span class="n">MapELResolver</span><span class="p">(</span><span class="kc">false</span><span class="p">));</span>
            <span class="n">add</span><span class="p">(</span><span class="k">new</span> <span class="n">ResourceBundleELResolver</span><span class="p">());</span>
            <span class="n">add</span><span class="p">(</span><span class="k">new</span> <span class="n">BeanELResolver</span><span class="p">(</span><span class="kc">false</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">class</span> <span class="nc">SiteSpringTilesInitializer</span> <span class="kd">extends</span> <span class="n">DefaultTilesInitializer</span> <span class="p">{</span>

        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="n">String</span> <span class="nf">getContainerKey</span><span class="p">(</span>
                <span class="n">ApplicationContext</span> <span class="n">applicationContext</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">containerKey</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="n">AbstractTilesContainerFactory</span> <span class="nf">createContainerFactory</span><span class="p">(</span><span class="n">ApplicationContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">SiteSpringTilesContainerFactory</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">class</span> <span class="nc">SiteSpringTilesContainerFactory</span> <span class="kd">extends</span> <span class="n">BasicTilesContainerFactory</span> <span class="p">{</span>

        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="n">TilesContainer</span> <span class="nf">createDecoratedContainer</span><span class="p">(</span><span class="n">TilesContainer</span> <span class="n">originalContainer</span><span class="p">,</span> <span class="n">ApplicationContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">useMutableTilesContainer</span> <span class="o">?</span> <span class="k">new</span> <span class="n">CachingTilesContainer</span><span class="p">(</span><span class="n">originalContainer</span><span class="p">)</span> <span class="p">:</span> <span class="n">originalContainer</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">ApplicationResource</span><span class="o">&gt;</span> <span class="nf">getSources</span><span class="p">(</span><span class="n">ApplicationContext</span> <span class="n">applicationContext</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">definitions</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">List</span><span class="o">&lt;</span><span class="n">ApplicationResource</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedList</span><span class="o">&lt;</span><span class="n">ApplicationResource</span><span class="o">&gt;</span><span class="p">();</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">String</span> <span class="n">definition</span> <span class="p">:</span> <span class="n">definitions</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">Collection</span><span class="o">&lt;</span><span class="n">ApplicationResource</span><span class="o">&gt;</span> <span class="n">resources</span> <span class="o">=</span> <span class="n">applicationContext</span><span class="p">.</span><span class="na">getResources</span><span class="p">(</span><span class="n">definition</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">resources</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">result</span><span class="p">.</span><span class="na">addAll</span><span class="p">(</span><span class="n">resources</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="kd">super</span><span class="p">.</span><span class="na">getSources</span><span class="p">(</span><span class="n">applicationContext</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="n">BaseLocaleUrlDefinitionDAO</span> <span class="nf">instantiateLocaleDefinitionDao</span><span class="p">(</span><span class="n">ApplicationContext</span> <span class="n">applicationContext</span><span class="p">,</span>
                                                                            <span class="n">LocaleResolver</span> <span class="n">resolver</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">BaseLocaleUrlDefinitionDAO</span> <span class="n">dao</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ModifyDefinitionDAO</span><span class="p">(</span><span class="n">applicationContext</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">checkRefresh</span> <span class="o">&amp;&amp;</span> <span class="n">dao</span> <span class="k">instanceof</span> <span class="n">CachingLocaleUrlDefinitionDAO</span><span class="p">)</span> <span class="p">{</span>
                <span class="p">((</span><span class="n">CachingLocaleUrlDefinitionDAO</span><span class="p">)</span> <span class="n">dao</span><span class="p">).</span><span class="na">setCheckRefresh</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">dao</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="n">DefinitionsReader</span> <span class="nf">createDefinitionsReader</span><span class="p">(</span><span class="n">ApplicationContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">DigesterDefinitionsReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="p">(</span><span class="n">DigesterDefinitionsReader</span><span class="p">)</span> <span class="kd">super</span><span class="p">.</span><span class="na">createDefinitionsReader</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
            <span class="n">reader</span><span class="p">.</span><span class="na">setValidating</span><span class="p">(</span><span class="n">validateDefinitions</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">reader</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="n">DefinitionsFactory</span> <span class="nf">createDefinitionsFactory</span><span class="p">(</span><span class="n">ApplicationContext</span> <span class="n">applicationContext</span><span class="p">,</span>
                                                              <span class="n">LocaleResolver</span> <span class="n">resolver</span><span class="p">)</span> <span class="p">{</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">definitionsFactoryClass</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">DefinitionsFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="n">BeanUtils</span><span class="p">.</span><span class="na">instantiate</span><span class="p">(</span><span class="n">definitionsFactoryClass</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">factory</span> <span class="k">instanceof</span> <span class="n">ApplicationContextAware</span><span class="p">)</span> <span class="p">{</span>
                    <span class="p">((</span><span class="n">ApplicationContextAware</span><span class="p">)</span> <span class="n">factory</span><span class="p">).</span><span class="na">setApplicationContext</span><span class="p">(</span><span class="n">applicationContext</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="n">BeanWrapper</span> <span class="n">bw</span> <span class="o">=</span> <span class="n">PropertyAccessorFactory</span><span class="p">.</span><span class="na">forBeanPropertyAccess</span><span class="p">(</span><span class="n">factory</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">bw</span><span class="p">.</span><span class="na">isWritableProperty</span><span class="p">(</span><span class="s">&quot;localeResolver&quot;</span><span class="p">))</span> <span class="p">{</span>
                    <span class="n">bw</span><span class="p">.</span><span class="na">setPropertyValue</span><span class="p">(</span><span class="s">&quot;localeResolver&quot;</span><span class="p">,</span> <span class="n">resolver</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">bw</span><span class="p">.</span><span class="na">isWritableProperty</span><span class="p">(</span><span class="s">&quot;definitionDAO&quot;</span><span class="p">))</span> <span class="p">{</span>
                    <span class="n">bw</span><span class="p">.</span><span class="na">setPropertyValue</span><span class="p">(</span><span class="s">&quot;definitionDAO&quot;</span><span class="p">,</span> <span class="n">createLocaleDefinitionDao</span><span class="p">(</span><span class="n">applicationContext</span><span class="p">,</span> <span class="n">resolver</span><span class="p">));</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="n">factory</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="kd">super</span><span class="p">.</span><span class="na">createDefinitionsFactory</span><span class="p">(</span><span class="n">applicationContext</span><span class="p">,</span> <span class="n">resolver</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="n">PreparerFactory</span> <span class="nf">createPreparerFactory</span><span class="p">(</span><span class="n">ApplicationContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">preparerFactoryClass</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">BeanUtils</span><span class="p">.</span><span class="na">instantiate</span><span class="p">(</span><span class="n">preparerFactoryClass</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="kd">super</span><span class="p">.</span><span class="na">createPreparerFactory</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="n">LocaleResolver</span> <span class="nf">createLocaleResolver</span><span class="p">(</span><span class="n">ApplicationContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">SpringLocaleResolver</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="n">AttributeEvaluatorFactory</span> <span class="nf">createAttributeEvaluatorFactory</span><span class="p">(</span><span class="n">ApplicationContext</span> <span class="n">context</span><span class="p">,</span>
                                                                            <span class="n">LocaleResolver</span> <span class="n">resolver</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">AttributeEvaluator</span> <span class="n">evaluator</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">tilesElPresent</span> <span class="o">&amp;&amp;</span> <span class="n">JspFactory</span><span class="p">.</span><span class="na">getDefaultFactory</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">evaluator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TilesElActivator</span><span class="p">().</span><span class="na">createEvaluator</span><span class="p">();</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">evaluator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DirectAttributeEvaluator</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">BasicAttributeEvaluatorFactory</span><span class="p">(</span><span class="n">evaluator</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">class</span> <span class="nc">TilesElActivator</span> <span class="p">{</span>

        <span class="kd">public</span> <span class="n">AttributeEvaluator</span> <span class="nf">createEvaluator</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">ELAttributeEvaluator</span> <span class="n">evaluator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ELAttributeEvaluator</span><span class="p">();</span>
            <span class="n">evaluator</span><span class="p">.</span><span class="na">setExpressionFactory</span><span class="p">(</span>
                    <span class="n">JspFactory</span><span class="p">.</span><span class="na">getDefaultFactory</span><span class="p">().</span><span class="na">getJspApplicationContext</span><span class="p">(</span><span class="n">servletContext</span><span class="p">).</span><span class="na">getExpressionFactory</span><span class="p">());</span>
            <span class="n">evaluator</span><span class="p">.</span><span class="na">setResolver</span><span class="p">(</span><span class="k">new</span> <span class="n">CompositeELResolverImpl</span><span class="p">());</span>
            <span class="k">return</span> <span class="n">evaluator</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<p>ModifyDefinitionDAO 中修改 tiles.xml 定义，也可以 load 一个新的xml 来覆盖 tiles.xml 中的定义</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ModifyDefinitionDAO</span> <span class="kd">extends</span> <span class="n">ResolvingLocaleUrlDefinitionDAO</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="nf">ModifyDefinitionDAO</span><span class="p">(</span><span class="n">ApplicationContext</span> <span class="n">applicationContext</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">super</span><span class="p">(</span><span class="n">applicationContext</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Definition</span><span class="o">&gt;</span> <span class="nf">loadDefinitionsFromResource</span><span class="p">(</span><span class="n">ApplicationResource</span> <span class="n">resource</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Definition</span><span class="o">&gt;</span> <span class="n">defsMap</span> <span class="o">=</span> <span class="kd">super</span><span class="p">.</span><span class="na">loadDefinitionsFromResource</span><span class="p">(</span><span class="n">resource</span><span class="p">);</span>

        <span class="c1">// modify DefinitionDAO</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">defsMap</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">modifyDefinition</span><span class="p">(</span><span class="n">defsMap</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">defsMap</span><span class="p">;</span>
    <span class="p">}</span>


    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">modifyDefinition</span><span class="p">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Definition</span><span class="o">&gt;</span> <span class="n">defsMap</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// modify login</span>
        <span class="n">Definition</span> <span class="n">loginDefinition</span> <span class="o">=</span> <span class="n">defsMap</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;login&quot;</span><span class="p">);</span>
        <span class="n">loginDefinition</span><span class="p">.</span><span class="na">getTemplateAttribute</span><span class="p">().</span><span class="na">setValue</span><span class="p">(</span><span class="s">&quot;/WEB-INF/jsp/example2login.jsp&quot;</span><span class="p">);</span>

        <span class="c1">// modify baselayout</span>
        <span class="n">Definition</span> <span class="n">layoutDefinition</span> <span class="o">=</span> <span class="n">defsMap</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;baselayout&quot;</span><span class="p">);</span>
        <span class="n">layoutDefinition</span><span class="p">.</span><span class="na">getTemplateAttribute</span><span class="p">().</span><span class="na">setValue</span><span class="p">(</span><span class="s">&quot;/WEB-INF/jsp/example2layout.jsp&quot;</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre></div>


<h2>结论</h2>
<p>以上代码可以完成目标，不过感觉不够灵活，不知道除了 theme 以外是否还有其他方案。</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="./tag/java.html">java</a>
    </p>
  </div>




    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <ins class="adsbygoogle ads-responsive"
         data-ad-client="ca-pub-8640171181637141"
         data-ad-slot="4393383534"></ins>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
    </script>

<!-- Disqus -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'astro-2';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
    Please enable JavaScript to view comments.
</noscript>
<!-- End Disqus -->
</article>

    <footer>
<p>&copy;  2020</p>
<p>Powered by <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Martin's Blog ",
  "url" : ".",
  "image": "/images/default_profile_200x200.png",
  "description": "Martin's Thoughts and Writings"
}
</script>

</body>
</html>